<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js" integrity="sha512-hZf9Qhp3rlDJBvAKvmiG+goaaKRZA6LKUO35oK6EsM0/kjPK32Yw7URqrq3Q+Nvbbt8Usss+IekL7CRn83dYmw==" crossorigin="anonymous"></script>
</head>
<body>
    <h1>
        Covid-19 Info From Around The World
    </h1>
    <div class="continents-btns">

    </div>
    <canvas id="myChart" width="400" height="400"></canvas>


    
    
    <script>
        class Continent {
            constructor(name, countries = []) {
                this.name = name;
                this.countries = countries;
            }
    }

        class Country {
            constructor(name, code) {
                this.name = name;
                this.code = code;
            }

            // 1. confirmed 2. deaths 3. recovered 4.critical 5. total cases (the same as 1?), 6.new cases 7.total deaths(same as 2?) 8.new deaths 9.total recovered(same as 3?) 10.in critical condition(same as 4?)
            setCovidInfo (confirmed, deaths, recovered, critical, totalCases, newCases, totalDeaths, newDeaths, totalRecovered) {
                this.confirmed = confirmed;
                this.deaths = deaths;
                this.recovered = recovered;
                this.critical = critical;
                this.totalCases = totalCases;
                this.newCases = newCases;
                this.totalDeaths = totalDeaths;
                this.newDeaths = newDeaths;
                this.totalRecovered = totalRecovered;
            }
        }

        const countriesAPI = 'https://restcountries.herokuapp.com/api/v1';
        const proxy = 'http://api.allorigins.win/raw?url';
        const covidAPI = 'https://corona-api.com/countries';


        async function fetchAndJson(url) {
            let data = await fetch(url);
            return data.json();
        }

        (async () => {
            // create an array of continents objects, each holds a countries array
            const continents = await createContinentArr();
            console.log(continents);
            // create information of continent: each state holds: 1. confirmed 2. deaths 3. recovered 4.critical 5. total cases (the same as 1?), 6.new cases 7.total deaths(same as 2?) 8.new deaths 9.total recovered(same as 3?) 10.in critical condition(same as 4?)
            await createCovidData(continents);
            continents.map(cont => {
                cont.countries.map(cou => {
                    console.log(cou)
                })
            })

            // add btns for the continents
            addContinentsBtns(continents);

            // add events listeners
            document.querySelector('.continent-btn').addEventListener('click', continentHandler);
            // document.querySelector('.continent-btn-info').addEventListener('click', continentInfoHandler);
            // document.querySelector('.country-btn').addEventListener('click',countryHandler); //TODO
        })()
        
        async function createContinentArr() { //TODO
            const countryData = await fetchAndJson(`${proxy}=${countriesAPI}`);
            return continents = countryData.reduce(fromAPIToContinentsArr, []);
        }

        function fromAPIToContinentsArr(continentsArr, country) {
            // if continent exist in the array
            const continentI = continentsArr.findIndex((value) => value.name === country.region);
            if (continentI != -1) {
                continentsArr[continentI].countries.push(new Country(country.name.common, country.cca2));
            } else { // if we should build the continent obj
                // build new continent, with the country obj in its array of countries
                continentsArr.push(new Continent(country.region, [new Country(country.name.common, country.cca2)]));
            }
            
            return continentsArr;
        }

        async function createCovidData(continents) {
            const covidData = await fetchAndJson(covidAPI);
            console.log(covidData);
            continents.forEach(cont => {
                if (cont)
                cont.countries.forEach(country => {
                    // get the covid info for this country
                    let countryData;
                    let i = 0;
                    while (!countryData && i < covidData.data.length) {
                        if (country.code === covidData.data[i].code){
                            countryData = covidData.data[i];
                            country.setCovidInfo(countryData.latest_data.confirmed, countryData.latest_data.deaths, countryData.latest_data.recovered, countryData.latest_data.critical, countryData.latest_data.deaths + countryData.latest_data.confirmed + countryData.latest_data.recovered, countryData.today.confirmed, countryData.latest_data.deaths, countryData.today.deaths, countryData.latest_data.recovered);//????????????????
                        }

                        i++;
                    }
                    
                })
            })
        }

        function addContinentsBtns(continents) {
            const contDiv = document.querySelector('.continents-btns');
            continents.forEach(continent => {
                // if there is a name of continent
                if (continent.name) {
                    const btn = document.createElement('button')
                    btn.innerText = `${continent.name}`;
                    btn.classList.add('continent-btn');
                    contDiv.appendChild(btn);
                }
            });
        }

        function continentHandler() {
            // check which continent is it
            // display the continent info - (confirmed/deaths/recovered/critical)

            // add the countries of the continent
        }

        function countryHandler() {
            
        }

        

        // create information of country

        // display the country info





        // var ctx = document.getElementById('myChart');

        // var myChart = new Chart(ctx, {
        //     type: 'line',
        //     data: {
        //         labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
        //         datasets: [{
        //             label: '# of Votes',
        //             data: [162, 19, 308, 75, 82, 183],
        //             backgroundColor: [
        //                 'rgba(0, 99, 132, 0.2)',
        //                 'rgba(0, 0, 0, 0.2)',
        //                 'rgba(255, 255, 255, 0.2)',
        //                 'rgba(75, 192, 192, 0.2)',
        //                 'rgba(153, 102, 255, 0.2)',
        //                 'rgba(255, 159, 64, 0.2)'
        //             ],
        //             borderColor: [
        //                 'rgba(255, 99, 132, 1)',
        //                 'rgba(54, 162, 235, 1)',
        //                 'rgba(255, 206, 86, 1)',
        //                 'rgba(75, 192, 192, 1)',
        //                 'rgba(153, 102, 255, 1)',
        //                 'rgba(255, 159, 64, 1)'
        //             ],
        //             borderWidth: 1
        //         }]
        //     },
        //     options: {
        //         scales: {
        //             yAxes: [{
        //                 ticks: {
        //                     beginAtZero: true
        //                 }
        //             }]
        //         }
        //     }
        // });

    </script>
</body>
</html>